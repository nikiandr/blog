<div
  class="flex items-center gap-1 p-1 bg-paper-200/50 dark:bg-paper_dark-100 border border-border/30 dark:border-border-dark/30 rounded-full"
>
  <button
    data-theme="light"
    class="theme-btn p-2 rounded-full transition-all duration-300"
    aria-label="Light theme"
    title="Light theme"
  >
    <svg
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
      />
    </svg>
  </button>

  <button
    data-theme="dark"
    class="theme-btn p-2 rounded-full transition-all duration-300"
    aria-label="Dark theme"
    title="Dark theme"
  >
    <svg
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
      />
    </svg>
  </button>

  <button
    data-theme="system"
    class="theme-btn p-2 rounded-full transition-all duration-300"
    aria-label="System theme"
    title="System theme"
  >
    <svg
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
      />
    </svg>
  </button>
</div>

<script>
  function applyTheme(theme: string) {
    const html = document.documentElement;

    if (theme === "system") {
      const systemPrefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      if (systemPrefersDark) {
        html.classList.add("dark");
      } else {
        html.classList.remove("dark");
      }
    } else if (theme === "dark") {
      html.classList.add("dark");
    } else {
      html.classList.remove("dark");
    }
  }

  function updateActiveButton(theme: string) {
    const buttons = document.querySelectorAll(".theme-btn");
    for (const btn of buttons) {
      const button = btn as HTMLButtonElement;
      const buttonTheme = button.dataset.theme;
      if (buttonTheme === theme) {
        button.classList.add(
          "bg-accent",
          "dark:bg-accent_dark",
          "text-white",
          "dark:text-paper_dark"
        );
        button.classList.remove(
          "text-ink-500",
          "dark:text-ink_dark-400",
          "hover:text-accent",
          "dark:hover:text-accent_dark"
        );
      } else {
        button.classList.remove(
          "bg-accent",
          "dark:bg-accent_dark",
          "text-white",
          "dark:text-paper_dark"
        );
        button.classList.add(
          "text-ink-500",
          "dark:text-ink_dark-400",
          "hover:text-accent",
          "dark:hover:text-accent_dark"
        );
      }
    }
  }

  function initThemeToggle() {
    const buttons = document.querySelectorAll(".theme-btn");
    const savedTheme = localStorage.getItem("theme") || "system";

    applyTheme(savedTheme);
    updateActiveButton(savedTheme);

    for (const btn of buttons) {
      btn.addEventListener("click", () => {
        const button = btn as HTMLButtonElement;
        const theme = button.dataset.theme || "system";
        localStorage.setItem("theme", theme);
        applyTheme(theme);
        updateActiveButton(theme);
      });
    }

    // Listen for system theme changes when in system mode
    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
    mediaQuery.addEventListener("change", () => {
      const currentTheme = localStorage.getItem("theme") || "system";
      if (currentTheme === "system") {
        applyTheme("system");
      }
    });
  }

  initThemeToggle();

  document.addEventListener("astro:after-swap", initThemeToggle);
</script>
